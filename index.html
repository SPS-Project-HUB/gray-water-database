<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gray Water Monitoring Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f4f8fb; font-family: 'Segoe UI', sans-serif; }
    .navbar { background: linear-gradient(90deg, #005f73, #0a9396); }
    .navbar-brand { color: #fff !important; font-weight: bold; font-size: 1.4rem; }
    .card { border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .card-title { color: #0a9396; font-weight: 600; }
    .footer { background: linear-gradient(90deg, #0a9396, #005f73); color: white; padding: 10px; text-align: center; margin-top: 20px; }
    table { font-size: 0.9rem; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Gray Water Dashboard</a>
    </div>
  </nav>

  <!-- Content -->
  <div class="container mt-4">
    <div class="row g-4">
      <div class="col-md-4"><div class="card text-center p-3"><h5 class="card-title">pH Value</h5><h2 id="phValue">--</h2></div></div>
      <div class="col-md-4"><div class="card text-center p-3"><h5 class="card-title">TDS (ppm)</h5><h2 id="tdsValue">--</h2></div></div>
      <div class="col-md-4"><div class="card text-center p-3"><h5 class="card-title">Flow Rate (L/min)</h5><h2 id="flowValue">--</h2></div></div>
    </div>

    <div class="row g-4 mt-2">
      <div class="col-md-6"><div class="card text-center p-3"><h5 class="card-title">Water Level 1 (%)</h5><h2 id="level1Value">--</h2></div></div>
      <div class="col-md-6"><div class="card text-center p-3"><h5 class="card-title">Water Level 2 (%)</h5><h2 id="level2Value">--</h2></div></div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mt-4">
      <div class="col-md-6"><div class="card p-3"><h5 class="card-title text-center">pH Trend</h5><canvas id="phChart"></canvas></div></div>
      <div class="col-md-6"><div class="card p-3"><h5 class="card-title text-center">TDS Trend</h5><canvas id="tdsChart"></canvas></div></div>
    </div>

    <div class="row g-4 mt-4">
      <div class="col-md-12"><div class="card p-3"><h5 class="card-title text-center">Flow Rate Trend</h5><canvas id="flowChart"></canvas></div></div>
    </div>

    <!-- Table Section -->
    <div class="row g-4 mt-4">
      <div class="col-md-12">
        <div class="card p-3">
          <h5 class="card-title text-center">Old Readings</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Time</th>
                  <th>pH</th>
                  <th>TDS (ppm)</th>
                  <th>Flow (L/min)</th>
                  <th>Level 1 (%)</th>
                  <th>Level 2 (%)</th>
                </tr>
              </thead>
              <tbody id="dataTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>Gray Water Monitoring System | <a href="https://github.com/" target="_blank" class="text-white">GitHub Repo</a></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2zBIHwuVu8ecBUViZUpKYYlxQ6i7mfRA",
      authDomain: "gray-water-database.firebaseapp.com",
      databaseURL: "https://gray-water-database-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gray-water-database",
      storageBucket: "gray-water-database.appspot.com",
      messagingSenderId: "858354713044",
      appId: "1:858354713044:web:642a008b6d77012f115641"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Chart setup
    const phChartRef = new Chart(document.getElementById("phChart"), {
      type: "line",
      data: { labels: [], datasets: [{ label: "pH", data: [], borderColor: "#0a9396", fill: false, tension: 0.3 }] }
    });
    const tdsChartRef = new Chart(document.getElementById("tdsChart"), {
      type: "line",
      data: { labels: [], datasets: [{ label: "TDS (ppm)", data: [], borderColor: "#005f73", fill: false, tension: 0.3 }] }
    });
    const flowChartRef = new Chart(document.getElementById("flowChart"), {
      type: "line",
      data: { labels: [], datasets: [{ label: "Flow (L/min)", data: [], borderColor: "#94d2bd", backgroundColor: "rgba(148,210,189,0.3)", fill: true, tension: 0.3 }] }
    });

    function updateCard(id, value) { document.getElementById(id).innerText = value; }

    function addData(chart, value) {
      const now = new Date().toLocaleTimeString();
      chart.data.labels.push(now);
      chart.data.datasets[0].data.push(value);
      if (chart.data.labels.length > 10) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    function addRow(time, pH, TDS, flow, l1, l2) {
      const table = document.getElementById("dataTable");
      const row = `<tr><td>${time}</td><td>${pH}</td><td>${TDS}</td><td>${flow}</td><td>${l1}</td><td>${l2}</td></tr>`;
      table.innerHTML = row + table.innerHTML; // new rows on top
    }

    // Realtime listener for history
    onValue(ref(db, "/history"), (snap) => {
      const data = snap.val();
      if (!data) return;
      const keys = Object.keys(data);
      const lastKey = keys[keys.length - 1];
      const latest = data[lastKey];

      const timestamp = new Date().toLocaleString();
      const pH = parseFloat(latest.pH) || 0;
      const TDS = parseFloat(latest.TDS) || 0;
      const flow = parseFloat(latest.flow) || 0;
      const l1 = parseFloat(latest.level1) || 0;
      const l2 = parseFloat(latest.level2) || 0;

      updateCard("phValue", pH.toFixed(2));
      updateCard("tdsValue", TDS.toFixed(1));
      updateCard("flowValue", flow.toFixed(2));
      updateCard("level1Value", l1.toFixed(1));
      updateCard("level2Value", l2.toFixed(1));

      addData(phChartRef, pH);
      addData(tdsChartRef, TDS);
      addData(flowChartRef, flow);

      addRow(timestamp, pH.toFixed(2), TDS.toFixed(1), flow.toFixed(2), l1.toFixed(1), l2.toFixed(1));
    });
  </script>
</body>
</html>
